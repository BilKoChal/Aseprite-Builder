name: Build Aseprite v1.3.16 (Windows x64)

on:
  workflow_dispatch:
    inputs:
      aseprite_ref:
        description: "Aseprite ref (tag/branch/commit)"
        required: true
        type: string
        default: "v1.3.16"

      # Optional override if auto-detect fails
      skia_release_tag:
        description: "Optional: aseprite/skia release tag (leave empty for auto)"
        required: false
        type: string
        default: ""

      # Adjust this if your chosen skia release uses different naming
      skia_asset_pattern:
        description: "Skia asset glob to download (Windows x64 Release zip)"
        required: true
        type: string
        default: "*windows*x64*.zip"

      build_type:
        description: "CMake build type"
        required: true
        type: choice
        default: "RelWithDebInfo"
        options: ["RelWithDebInfo", "Release", "Debug"]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout Aseprite (with submodules)
        uses: actions/checkout@v4
        with:
          repository: aseprite/aseprite
          ref: ${{ inputs.aseprite_ref }}
          path: aseprite
          submodules: recursive

      - name: Install build tools (CMake, Ninja, gh, OpenSSL)
        shell: pwsh
        run: |
          choco install -y cmake ninja gh openssl.light

      - name: Setup MSVC (x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Decide Skia release tag (auto from INSTALL.md)
        id: skia
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $override = "${{ inputs.skia_release_tag }}".Trim()
          if ($override) {
            "SKIA_TAG=$override" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          $installMd = Join-Path "aseprite" "INSTALL.md"
          if (-not (Test-Path $installMd)) { throw "Missing aseprite/INSTALL.md" }

          $txt = Get-Content $installMd -Raw
          $m = [regex]::Match($txt, "aseprite-m(\d+)")
          if (-not $m.Success) {
            throw "Couldn't find 'aseprite-m###' in INSTALL.md. Set inputs.skia_release_tag manually."
          }

          $skiaM = $m.Groups[1].Value
          Write-Host "Detected required Skia branch: aseprite-m$skiaM"

          $releases = gh api "repos/aseprite/skia/releases" --paginate | ConvertFrom-Json

          # Commonly tags are like m124-...; pick first match
          $hit = $releases | Where-Object { $_.tag_name -like "m$skiaM-*" } | Select-Object -First 1
          if (-not $hit) {
            throw "No aseprite/skia release tag like m$skiaM-* found. Set inputs.skia_release_tag manually."
          }

          "SKIA_TAG=$($hit.tag_name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Download + extract Skia (prebuilt)
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $skiaRoot = "C:\deps\skia"
          $tmp = Join-Path $env:RUNNER_TEMP "skia_dl"
          $x = Join-Path $env:RUNNER_TEMP "skia_extract"

          New-Item -ItemType Directory -Force -Path $tmp, $x, $skiaRoot | Out-Null

          gh release download "${{ steps.skia.outputs.SKIA_TAG }}" `
            -R "aseprite/skia" `
            -p "${{ inputs.skia_asset_pattern }}" `
            -D "$tmp"

          $zip = Get-ChildItem "$tmp" -Filter "*.zip" | Select-Object -First 1
          if (-not $zip) { throw "No Skia zip downloaded. Adjust skia_asset_pattern or set skia_release_tag." }

          Expand-Archive -Path $zip.FullName -DestinationPath $x -Force

          # Find a folder that contains out\Release-x64\skia.lib
          $candidate = Get-ChildItem $x -Directory -Recurse | Where-Object {
            Test-Path (Join-Path $_.FullName "out\Release-x64\skia.lib")
          } | Select-Object -First 1

          if (-not $candidate) {
            if (Test-Path (Join-Path $x "out\Release-x64\skia.lib")) {
              $candidate = Get-Item $x
            } else {
              throw "Can't locate out\Release-x64\skia.lib inside extracted Skia."
            }
          }

          Remove-Item "$skiaRoot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item (Join-Path $candidate.FullName "*") $skiaRoot -Recurse -Force

          if (-not (Test-Path "C:\deps\skia\out\Release-x64\skia.lib")) {
            throw "Skia install failed: C:\deps\skia\out\Release-x64\skia.lib not found."
          }

      - name: Configure (CMake + Ninja)
        shell: pwsh
        working-directory: aseprite
        run: |
          New-Item -ItemType Directory -Force -Path build | Out-Null
          cd build

          cmake `
            -G Ninja `
            -DCMAKE_BUILD_TYPE="${{ inputs.build_type }}" `
            -DLAF_BACKEND=skia `
            -DSKIA_DIR="C:\deps\skia" `
            -DSKIA_LIBRARY_DIR="C:\deps\skia\out\Release-x64" `
            -DSKIA_LIBRARY="C:\deps\skia\out\Release-x64\skia.lib" `
            ..

      - name: Build (ninja aseprite)
        shell: pwsh
        working-directory: aseprite/build
        run: |
          ninja aseprite

      - name: Bundle OpenSSL runtime next to aseprite.exe
        shell: pwsh
        run: |
          $bin = "aseprite\build\bin"
          if (-not (Test-Path $bin)) { throw "Missing $bin" }

          function Find-FirstExistingFile($candidates) {
            foreach ($p in $candidates) { if (Test-Path $p) { return $p } }
            return $null
          }

          # Prefer "where" (works if OpenSSL bin is on PATH), otherwise check common install dirs.
          $libcrypto = $null
          try { $libcrypto = (where.exe libcrypto-3-x64.dll 2>$null | Select-Object -First 1) } catch {}
          if (-not $libcrypto) {
            $libcrypto = Find-FirstExistingFile @(
              "C:\Program Files\OpenSSL-Win64\bin\libcrypto-3-x64.dll",
              "C:\Program Files\OpenSSL\bin\libcrypto-3-x64.dll"
            )
          }
          if (-not $libcrypto) { throw "Can't find libcrypto-3-x64.dll after installing openssl.light" }

          $opensslBin = Split-Path $libcrypto -Parent
          $opensslRoot = Split-Path $opensslBin -Parent

          $libssl = Find-FirstExistingFile @(
            (Join-Path $opensslBin "libssl-3-x64.dll"),
            "C:\Program Files\OpenSSL-Win64\bin\libssl-3-x64.dll",
            "C:\Program Files\OpenSSL\bin\libssl-3-x64.dll"
          )
          if (-not $libssl) { throw "Can't find libssl-3-x64.dll" }

          Copy-Item $libcrypto $bin -Force
          Copy-Item $libssl    $bin -Force

          # Copy OpenSSL 3 provider modules if present (helps avoid follow-up errors)
          $modulesDir = Find-FirstExistingFile @(
            (Join-Path $opensslRoot "lib\ossl-modules"),
            "C:\Program Files\OpenSSL-Win64\lib\ossl-modules",
            "C:\Program Files\OpenSSL\lib\ossl-modules"
          )
          if ($modulesDir) {
            Copy-Item $modulesDir (Join-Path $bin "ossl-modules") -Recurse -Force
          }

      - name: Smoke test
        shell: pwsh
        run: |
          $exe = "aseprite\build\bin\aseprite.exe"
          if (-not (Test-Path $exe)) { throw "Expected $exe" }
          & $exe --version

      - name: Zip build/bin (portable folder)
        shell: pwsh
        run: |
          $bin = "aseprite\build\bin"
          $zipName = "aseprite-windows-x64-${{ inputs.aseprite_ref }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path "$bin\*" -DestinationPath $zipName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aseprite-windows-x64-${{ inputs.aseprite_ref }}
          path: aseprite-windows-x64-*.zip
          retention-days: 14
          if-no-files-found: error
