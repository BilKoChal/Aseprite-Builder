name: Build Aseprite (Windows)

on:
  workflow_dispatch:
    inputs:
      aseprite_ref:
        description: "Aseprite ref (tag/branch/commit)"
        required: true
        type: string
        default: "v1.3.16"

      # Optional override if auto-detect fails
      skia_release_tag:
        description: "Optional: aseprite/skia release tag (leave empty for auto)"
        required: false
        type: string
        default: ""

      # Adjust if needed after looking at aseprite/skia release assets
      skia_asset_pattern:
        description: "Skia asset filename glob (Windows x64 Release zip)"
        required: true
        type: string
        default: "*Windows*Release*x64*.zip"

      build_type:
        description: "CMake build type"
        required: true
        type: choice
        default: "RelWithDebInfo"
        options: [ "RelWithDebInfo", "Release", "Debug" ]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout Aseprite (selected ref)
        uses: actions/checkout@v4
        with:
          repository: aseprite/aseprite
          ref: ${{ inputs.aseprite_ref }}
          path: aseprite
          submodules: recursive

      - name: Install tools (CMake, Ninja)
        shell: pwsh
        run: |
          choco install -y cmake ninja

      - name: Setup MSVC (x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Decide Skia release tag (auto)
        id: skia
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $override = "${{ inputs.skia_release_tag }}".Trim()
          if ($override) {
            "SKIA_TAG=$override" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          $installMd = Join-Path "aseprite" "INSTALL.md"
          if (-not (Test-Path $installMd)) { throw "Missing aseprite/INSTALL.md" }

          $txt = Get-Content $installMd -Raw
          $m = [regex]::Match($txt, "aseprite-m(\d+)")
          if (-not $m.Success) {
            throw "Couldn't find 'aseprite-m###' in INSTALL.md. Provide inputs.skia_release_tag manually."
          }

          $skiaM = $m.Groups[1].Value
          Write-Host "Detected required Skia branch: aseprite-m$skiaM"

          $releases = gh api "repos/aseprite/skia/releases" --paginate | ConvertFrom-Json
          $hit = $releases | Where-Object { $_.tag_name -like "m$skiaM-*" } | Select-Object -First 1

          if (-not $hit) {
            throw "Couldn't find a skia release tag like m$skiaM-* . Provide inputs.skia_release_tag manually."
          }

          "SKIA_TAG=$($hit.tag_name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Download + extract Skia (prebuilt)
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $skiaRoot = "C:\deps\skia"
          $tmp = Join-Path $env:RUNNER_TEMP "skia_dl"
          $x = Join-Path $env:RUNNER_TEMP "skia_extract"

          New-Item -ItemType Directory -Force -Path $tmp, $x, $skiaRoot | Out-Null

          gh release download "${{ steps.skia.outputs.SKIA_TAG }}" `
            -R "aseprite/skia" `
            -p "${{ inputs.skia_asset_pattern }}" `
            -D "$tmp"

          $zip = Get-ChildItem "$tmp" -Filter "*.zip" | Select-Object -First 1
          if (-not $zip) { throw "No Skia zip downloaded. Adjust skia_asset_pattern or set skia_release_tag." }

          Expand-Archive -Path $zip.FullName -DestinationPath $x -Force

          # Find a folder that actually contains out\Release-x64\skia.lib, then copy its top-level content into C:\deps\skia
          $candidate = Get-ChildItem $x -Directory -Recurse | Where-Object {
            Test-Path (Join-Path $_.FullName "out\Release-x64\skia.lib")
          } | Select-Object -First 1

          if (-not $candidate) {
            # maybe the archive extracts directly into $x
            if (Test-Path (Join-Path $x "out\Release-x64\skia.lib")) {
              $candidate = Get-Item $x
            } else {
              throw "Can't locate out\Release-x64\skia.lib inside the extracted Skia archive."
            }
          }

          Remove-Item "$skiaRoot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item (Join-Path $candidate.FullName "*") $skiaRoot -Recurse -Force

          if (-not (Test-Path "C:\deps\skia\out\Release-x64\skia.lib")) {
            throw "Skia install failed: C:\deps\skia\out\Release-x64\skia.lib not found."
          }

      - name: Configure (CMake + Ninja, Skia backend)
        shell: pwsh
        working-directory: aseprite
        run: |
          New-Item -ItemType Directory -Force -Path build | Out-Null
          cd build

          cmake `
            -G Ninja `
            -DCMAKE_BUILD_TYPE="${{ inputs.build_type }}" `
            -DLAF_BACKEND=skia `
            -DSKIA_DIR="C:\deps\skia" `
            -DSKIA_LIBRARY_DIR="C:\deps\skia\out\Release-x64" `
            -DSKIA_LIBRARY="C:\deps\skia\out\Release-x64\skia.lib" `
            ..

      - name: Build
        shell: pwsh
        working-directory: aseprite/build
        run: |
          ninja aseprite

      - name: Package (build/bin)
        shell: pwsh
        run: |
          $bin = "aseprite\build\bin"
          $exe = Join-Path $bin "aseprite.exe"
          if (-not (Test-Path $exe)) { throw "Expected $exe" }

          & $exe --version

          $zipName = "aseprite-windows-x64-${{ inputs.aseprite_ref }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path "$bin\*" -DestinationPath $zipName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aseprite-windows-x64-${{ inputs.aseprite_ref }}
          path: aseprite-windows-x64-*.zip
          retention-days: 14
          if-no-files-found: error
