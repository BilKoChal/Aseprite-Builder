name: Build Aseprite (Windows x64)

on:
  workflow_dispatch:
    inputs:
      aseprite_ref:
        description: "Aseprite ref (tag/branch/commit)"
        required: true
        type: string
        default: "v1.3.16"

      # Optional override if auto-detect fails
      skia_release_tag:
        description: "Optional: aseprite/skia release tag (leave empty for auto)"
        required: false
        type: string
        default: ""

      # Most common asset name; if it fails, the workflow will print available assets.
      skia_asset_name:
        description: "Exact Skia asset name inside that release"
        required: true
        type: string
        default: "Skia-Windows-Release-x64.zip"

      build_type:
        description: "CMake build type"
        required: true
        type: choice
        default: "RelWithDebInfo"
        options: ["RelWithDebInfo", "Release", "Debug"]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout Aseprite (with submodules)
        uses: actions/checkout@v4
        with:
          repository: aseprite/aseprite
          ref: ${{ inputs.aseprite_ref }}
          path: aseprite
          submodules: recursive

      - name: Force version string (so title shows chosen ref)
        shell: pwsh
        working-directory: aseprite
        run: |
          $ref = "${{ inputs.aseprite_ref }}".Trim()

          # Normalize: "v1.3.16" -> "1.3.16"
          $ver = $ref
          if ($ver.StartsWith("refs/tags/")) { $ver = $ver.Substring(10) }
          $ver = $ver.Trim()
          if ($ver.StartsWith("v")) { $ver = $ver.Substring(1) }

          $p = "src/ver/CMakeLists.txt"
          if (-not (Test-Path $p)) { throw "Missing $p" }

          $s = Get-Content $p -Raw
          $new = [regex]::Replace($s, 'set\s*\(\s*ver\s+"[^"]*"\s*\)', "set(ver `"$ver`")")

          if ($new -eq $s) {
            Write-Host "Couldn't patch $p automatically; file content:"
            Get-Content $p
            throw "Version patch failed (pattern not found)."
          }

          Set-Content -Path $p -Value $new -Encoding UTF8 -NoNewline

      - name: Install build tools (CMake, Ninja, gh, OpenSSL)
        shell: pwsh
        run: |
          choco install -y cmake ninja gh openssl.light

      - name: Setup MSVC (x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Decide Skia release tag (auto from INSTALL.md)
        id: skia
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $override = "${{ inputs.skia_release_tag }}".Trim()
          if ($override) {
            "SKIA_TAG=$override" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          $installMd = Join-Path "aseprite" "INSTALL.md"
          if (-not (Test-Path $installMd)) { throw "Missing aseprite/INSTALL.md" }

          $txt = Get-Content $installMd -Raw
          $m = [regex]::Match($txt, "aseprite-m(\d+)")
          if (-not $m.Success) {
            throw "Couldn't find 'aseprite-m###' in INSTALL.md. Set inputs.skia_release_tag manually."
          }

          $skiaM = $m.Groups[1].Value
          Write-Host "Detected required Skia branch: aseprite-m$skiaM"

          $releases = gh api "repos/aseprite/skia/releases" --paginate | ConvertFrom-Json
          $hit = $releases | Where-Object { $_.tag_name -like "m$skiaM-*" } | Select-Object -First 1
          if (-not $hit) {
            throw "No aseprite/skia release tag like m$skiaM-* found. Set inputs.skia_release_tag manually."
          }

          "SKIA_TAG=$($hit.tag_name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Download + extract Skia (prebuilt)
        id: skiapaths
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $skiaRoot = "C:\deps\skia"
          $tmp = Join-Path $env:RUNNER_TEMP "skia_dl"
          $x = Join-Path $env:RUNNER_TEMP "skia_extract"

          New-Item -ItemType Directory -Force -Path $tmp, $x, $skiaRoot | Out-Null

          $tag = "${{ steps.skia.outputs.SKIA_TAG }}"
          $want = "${{ inputs.skia_asset_name }}".Trim()

          $rel = gh api "repos/aseprite/skia/releases/tags/$tag" | ConvertFrom-Json
          $asset = $rel.assets | Where-Object { $_.name -eq $want } | Select-Object -First 1

          if (-not $asset) {
            Write-Host "Available assets in $($rel.tag_name):"
            $rel.assets | ForEach-Object { Write-Host " - $($_.name)" }
            throw "Asset '$want' not found. Set inputs.skia_asset_name to one of the listed assets."
          }

          gh release download "$tag" -R "aseprite/skia" -p "$($asset.name)" -D "$tmp"

          $zip = Get-ChildItem "$tmp" -Filter "*.zip" | Select-Object -First 1
          if (-not $zip) { throw "Skia zip download failed unexpectedly." }

          Expand-Archive -Path $zip.FullName -DestinationPath $x -Force

          Remove-Item "$skiaRoot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item (Join-Path $x "*") $skiaRoot -Recurse -Force

          # Robustly locate skia.lib (handles different out folder names)
          $skiaLib = Get-ChildItem "C:\deps\skia\out" -Recurse -Filter "skia.lib" -ErrorAction SilentlyContinue |
            Select-Object -First 1

          if (-not $skiaLib) {
            Write-Host "Skia folder content:"
            Get-ChildItem "C:\deps\skia" -Recurse -Depth 4 | Select-Object FullName
            throw "Couldn't find skia.lib under C:\deps\skia\out"
          }

          $skiaLibDir = Split-Path $skiaLib.FullName -Parent

          "SKIA_DIR=C:\deps\skia" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "SKIA_LIBRARY=$($skiaLib.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "SKIA_LIBRARY_DIR=$skiaLibDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Configure (CMake + Ninja)
        shell: pwsh
        working-directory: aseprite
        run: |
          New-Item -ItemType Directory -Force -Path build | Out-Null
          cd build

          cmake `
            -G Ninja `
            -DCMAKE_BUILD_TYPE="${{ inputs.build_type }}" `
            -DLAF_BACKEND=skia `
            -DSKIA_DIR="${{ steps.skiapaths.outputs.SKIA_DIR }}" `
            -DSKIA_LIBRARY_DIR="${{ steps.skiapaths.outputs.SKIA_LIBRARY_DIR }}" `
            -DSKIA_LIBRARY="${{ steps.skiapaths.outputs.SKIA_LIBRARY }}" `
            ..

      - name: Build (ninja aseprite)
        shell: pwsh
        working-directory: aseprite/build
        run: |
          ninja aseprite

      - name: Bundle OpenSSL runtime next to aseprite.exe
        shell: pwsh
        run: |
          $bin = "aseprite\build\bin"
          if (-not (Test-Path $bin)) { throw "Missing $bin" }

          function Find-FirstExistingFile($candidates) {
            foreach ($p in $candidates) { if (Test-Path $p) { return $p } }
            return $null
          }

          $libcrypto = $null
          try { $libcrypto = (where.exe libcrypto-3-x64.dll 2>$null | Select-Object -First 1) } catch {}

          if (-not $libcrypto) {
            $libcrypto = Find-FirstExistingFile @(
              "C:\Program Files\OpenSSL-Win64\bin\libcrypto-3-x64.dll",
              "C:\Program Files\OpenSSL\bin\libcrypto-3-x64.dll"
            )
          }
          if (-not $libcrypto) { throw "Can't find libcrypto-3-x64.dll after installing openssl.light" }

          $opensslBin = Split-Path $libcrypto -Parent
          $opensslRoot = Split-Path $opensslBin -Parent

          $libssl = Find-FirstExistingFile @(
            (Join-Path $opensslBin "libssl-3-x64.dll"),
            "C:\Program Files\OpenSSL-Win64\bin\libssl-3-x64.dll",
            "C:\Program Files\OpenSSL\bin\libssl-3-x64.dll"
          )
          if (-not $libssl) { throw "Can't find libssl-3-x64.dll" }

          Copy-Item $libcrypto $bin -Force
          Copy-Item $libssl    $bin -Force

          $modulesDir = Find-FirstExistingFile @(
            (Join-Path $opensslRoot "lib\ossl-modules"),
            "C:\Program Files\OpenSSL-Win64\lib\ossl-modules",
            "C:\Program Files\OpenSSL\lib\ossl-modules"
          )
          if ($modulesDir) {
            Copy-Item $modulesDir (Join-Path $bin "ossl-modules") -Recurse -Force
          }

      - name: Smoke test
        shell: pwsh
        run: |
          $exe = "aseprite\build\bin\aseprite.exe"
          if (-not (Test-Path $exe)) { throw "Expected $exe" }
          & $exe --version

      - name: Zip build/bin (portable folder)
        shell: pwsh
        run: |
          $bin = "aseprite\build\bin"
          $zipName = "aseprite-windows-x64-${{ inputs.aseprite_ref }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path "$bin\*" -DestinationPath $zipName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aseprite-windows-x64-${{ inputs.aseprite_ref }}
          path: aseprite-windows-x64-*.zip
          retention-days: 14
          if-no-files-found: error
